<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3. How to deal with convergence problems • EcoDiet</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="3. How to deal with convergence problems">
<meta property="og:description" content="EcoDiet">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EcoDiet</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction_EcoDiet.html">1. Introduction - How to use EcoDiet</a>
    </li>
    <li>
      <a href="../articles/realistic_example.html">2. EcoDiet explored on a realistic example</a>
    </li>
    <li>
      <a href="../articles/convergence_problems.html">3. How to deal with convergence problems</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pyhernvann/EcoDiet/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>3. How to deal with convergence problems</h1>
                        <h4 data-toc-skip class="author">Heloise Thero,
Pierre-Yves Hernvann</h4>
            
            <h4 data-toc-skip class="date">2024-07-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pyhernvann/EcoDiet/blob/HEAD/vignettes/convergence_problems.Rmd" class="external-link"><code>vignettes/convergence_problems.Rmd</code></a></small>
      <div class="hidden name"><code>convergence_problems.Rmd</code></div>

    </div>

    
    
<p>This vignette help you deal with troubling messages from the
<code>run_model</code> function.</p>
<p>Example of model (NB: the <code>preprocess_data</code>,
<code>write_model</code> and <code>run_model</code> functions must have
been run without errors before trying to solve the convergence
problems):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pyhernvann/EcoDiet" class="external-link">EcoDiet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">example_stomach_data_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example_stomach_data.csv"</span>,</span>
<span>                                    package <span class="op">=</span> <span class="st">"EcoDiet"</span><span class="op">)</span></span>
<span><span class="va">example_biotracer_data_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example_biotracer_data.csv"</span>,</span>
<span>                                    package <span class="op">=</span> <span class="st">"EcoDiet"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_data.html">preprocess_data</a></span><span class="op">(</span>biotracer_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">example_biotracer_data_path</span><span class="op">)</span>,</span>
<span>                        trophic_discrimination_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">3.4</span><span class="op">)</span>,</span>
<span>                        literature_configuration <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                        stomach_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">example_stomach_data_path</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"mymodel.txt"</span></span>
<span><span class="fu"><a href="../reference/write_model.html">write_model</a></span><span class="op">(</span>file.name <span class="op">=</span> <span class="va">filename</span>, literature_configuration <span class="op">=</span> <span class="va">literature_configuration</span>, print.model <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">mcmc_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">filename</span>, <span class="va">data</span>, run_param<span class="op">=</span><span class="st">"test"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="issues-you-can-face">Issues you can face<a class="anchor" aria-label="anchor" href="#issues-you-can-face"></a>
</h2>
<p>Several issues can be encountered when running Bayesian models that
use Markov Chain Monte Carlo (MCMC) simulation. These issues are linked
to the MCMC samplers, i.e. the objects that will be used to update the
parameters of the model at each iteration, first drawing values from
prior distributions, to then progressively moving over a posterior
distribution and converge on a target distribution.</p>
<div class="section level3">
<h3 id="adaptation-issues">Adaptation issues<a class="anchor" aria-label="anchor" href="#adaptation-issues"></a>
</h3>
<p>In some (infrequent) cases, you may encounter issues during the
adaptation phase. The adaptation phase is a period during which, once a
model has been initialized, the samplers modify their behavior (hence,
<em>adapting</em> to the model structure) for an increased efficiency of
the forthcoming sampling process. Adaptation phase issues will occur
within JAGS and will then be communicated to the R package exchanging
with it (here, <code>jagsUI</code>), which should then print a warning
message and potentially stop the model run.</p>
<p>In this situation, you should see in the console a <em>Adaptation
incomplete</em> warning or a <em>Stopping adaptation</em> note. Such
messages indicate that the samplers are not optimized for your model
after the Adaptation phase. This tends to happen in complex models for a
too small number of adaptation steps (<code>nb_adapt</code>). In the v
2.0.0, <code>EcoDiet</code> is run with the <code>jagsUI</code> package,
which does not require to specify an number of adaptation steps. By
default , <code>jagsUI</code> will run groups of 100 adaptation
iterations, up to a maximum of 10,000 iterations, until JAGS identifies
the adaptation as sufficient. If such adaptation warnings/notes appear,
it means that the default number of adaptation steps in jagsUI is still
too low and that you should manually specify a higher number of
adaptation steps using <code>nb_adapt</code> in the
<code>run_param</code> argument of the <code>model_run</code> function
as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">mcmc_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">filename</span>, <span class="va">data</span>, run_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb_iter<span class="op">=</span><span class="fl">100000</span>, nb_burnin<span class="op">=</span><span class="fl">50000</span>, nb_thin<span class="op">=</span><span class="fl">50</span>, nb_adapt<span class="op">=</span><span class="fl">50000</span><span class="op">)</span>, parallelize <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Because of the number of iterations used for the default adaptation
phase by jagsUI, we recommend to start with nb_adapt &gt; 10,000.</p>
</div>
<div class="section level3">
<h3 id="convergence-issues">Convergence issues<a class="anchor" aria-label="anchor" href="#convergence-issues"></a>
</h3>
<p>In theory, an MCMC sampler should converge to the target distribution
as the number of iterations tends to infinite. However, MCMC simulation
are (luckily) less-than-infinite. For several reasons, one or several
variables may have difficulties to converged over that target
distribution.</p>
<p>In this situation, you should be notified in by:</p>
<ul>
<li><p>The <code>jagsUI</code> package, that will flag any convergence
failures (Rhat &gt; 1.1) by the following message <em>WARNING Rhat
values indicate convergence failure</em>. This message will be displayed
in the summary paragraph provided at the end of the
<code>run_model</code> run.</p></li>
<li><p>The <code>EcoDiet</code> model, which will print a
<em>Convergence warning</em> (red text). The number of variables not
converging displayed in the warning, relatively to the total number of
variables monitored, will give you an idea of the convergence issues
extent. It will also indicate a potential convergence failure based on
the same criteria and indicate the number of variables for which
convergence diagnostic is not satisfying</p></li>
</ul>
<p>As previously mentioned, convergence issues could be related to one
or several variables and may be of variable importance. The first thing
to do in case of convergence issues will be to investigate this
further.</p>
<p>The <code>EcoDiet</code> package provides you with several ways of
checking/exploring convergence.</p>
<ul>
<li><p>The <code>jagsUI</code> package on which is based
<code>EcoDiet</code> (version &gt;= 2.0.0) prints at the end of each
model run a short summary of the model configuration, statistics on the
MCMC samples and information on the convergence of the variables.
Convergence is assessed via the Gelman-Rubin diagnostic that you will be
able to check in the summary table printed in the console, also
accessible within the jagsUI object returned by the
<code>run_model</code> function .</p></li>
<li><p>A <code>EcoDiet</code> built-in <em>Convergence warning</em>
message is systematically returned by the <code>run_model</code>
function (red text).</p></li>
<li><p>The new <code>diagnose_model</code> function allows you to
perform the more complete Gelman-Rubin diagnostic on the MCMC outputs
and compile all these coefficients in a matrix object. It can also
produce a <code>.pdf</code> document with complete diagnostic plots if
interested.</p></li>
</ul>
<p>[Note that, in the present version of the <code>EcoDiet</code>
package, all convergence diagnostics are based on Gelman-Rubin test. In
the future, other diagnostics could be integrated. If you are used to
work with models employing GIBS or other MCMC techniques, you could also
directly use the jasgUI outputs to test other flavors of convergence
diagnostic.]</p>
<p>To summary, in terms of code, you can investigate the convergence of
the model by alternatively running the following:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Option 1: use the jagsUI object</span></span>
<span><span class="va">mcmc_output_example</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Rhat"</span>, <span class="st">"n.eff"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Option 2: diagnose function</span></span>
<span><span class="va">Gelman_diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diagnose_model.html">diagnose_model</a></span><span class="op">(</span><span class="va">mcmc_output_example</span><span class="op">)</span> <span class="co"># just display the Gelman-Rubin diagnostic</span></span>
<span><span class="va">Gelman_diag</span></span>
<span></span>
<span><span class="co"># Option 3: diagnose function</span></span>
<span><span class="va">Gelman_diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diagnose_model.html">diagnose_model</a></span><span class="op">(</span><span class="va">mcmc_output_example</span>, var.to.diag <span class="op">=</span> <span class="st">"all"</span>, save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Display the Gelman-Rubin diagnostic and produce the plots</span></span>
<span><span class="va">Gelman_diag</span></span></code></pre></div>
<p>You should use this information to elaborate some strategies for
tackling convergence issues.</p>
</div>
</div>
<div class="section level2">
<h2 id="how-to-tackle-convergence-issues">How to tackle convergence issues<a class="anchor" aria-label="anchor" href="#how-to-tackle-convergence-issues"></a>
</h2>
<div class="section level3">
<h3 id="increase-the-number-of-iterations">Increase the number of iterations<a class="anchor" aria-label="anchor" href="#increase-the-number-of-iterations"></a>
</h3>
<p>The first and easy thing that you should try is setting a higher
number of iterations steps to run the model. Be aware that, depending on
your data (e.g., food-web complexity, data informativeness), this can
take <strong>hours or days</strong> to run. Using the model shortcuts
provided in version 2.0.0, you could for example successively try to run
youyr model in the “normal”, “long” then “very long” configurations.</p>
<p>Increasing the number of iterations is a good solution in many cases
and you should start from this. It would definitly look especially
pertinent when convergence diagnoses show that, additionally to a
substantial number of variables with numerous variables have a Rhat &gt;
1.1, a lot of them are between 1.05 and 1.01.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">filename</span>, <span class="va">data</span>, run_param<span class="op">=</span><span class="st">"normal"</span><span class="op">)</span></span>
<span><span class="va">mcmc_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">filename</span>, <span class="va">data</span>, run_param<span class="op">=</span><span class="st">"long"</span><span class="op">)</span></span>
<span><span class="va">mcmc_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">filename</span>, <span class="va">data</span>, run_param<span class="op">=</span><span class="st">"very long"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="increase-the-number-of-adaptation-steps">Increase the number of adaptation steps<a class="anchor" aria-label="anchor" href="#increase-the-number-of-adaptation-steps"></a>
</h3>
<p>For very complex models, you may see also consider to increase the
adaptation phase as specified in the dedicated paragraph above. Even if
the adaptation is considered “sufficient” by JAGS, it doesn’t mean that
the samplers can’t be still better designed to fit the model structure.
Manually setting an nb_adapt and progressively increase its value may
still enhance the efficiency of your samplers and allow the model to
reach better convergence for the same number of iterations. By keeping
the number of iterations constant, you can progressively increase the
<code>nb_adapt</code> as long as it seems to have an impact on
convergence.</p>
<p>Using this lever would look relevant if you reach low Rhat for many
variables but still have a small set of variables that exceed 1.1, and
if these variables are not systematically the same.</p>
<p>Please note that the model configurations associated with the
<code>run_param</code> shortcuts always specify nb_adapt.</p>
</div>
<div class="section level3">
<h3 id="specify-initial-values-for-the-model">Specify initial values for the model<a class="anchor" aria-label="anchor" href="#specify-initial-values-for-the-model"></a>
</h3>
<p>The next step might be to define starting values from which to run
the MCMC chains. By default JAGS will use the prior distributions to
randomly fix the starting values of the chains, which can cause
problems.</p>
<p>A large inconsistency between the literature priors and the data can
eventually create convergence problems. Thus, first check and eventually
modify the prior distributions used through the
<code>literature_diets</code> table, the <code>nb_literature</code> and
the <code>literature_slope</code> parameters (if you used priors from
the literature).</p>
<p>Or you can try to manually set a good set of fixed values for
initializing MCMC chains, i.e., fixed values that you know are close to
the values you want the model to converge to. This way the model is
given a good start and it should be faster to converge.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>If you still have an ‘adaptation incomplete’ warning or ‘Stopping
adaptation’ note, you can just live with the sub-optimal sampler
efficiency and run the model for a higher number of iterations.</p>
<p>If you still have a ‘convergence problem’ message, you cannot use the
obtained results as they are clearly incorrect. However, note that for
highly complex case studies, the dimension of the model may be
considerable hence the time required by the runs may be dramatically
long. In that context, while analyzing your results carefully, you might
be willing to use your model outputs if a only a very limited number of
variables don’t reach convergence after especially long runs but are
really close from convergence. This should only done after exploration
of all existing means to reach full convergence of the model.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Pierre-Yves Hernvann, Didier Gascuel, Dorothee Kopp, Marianne Robert, Jerome Guitton, Etienne Rivot, Heloise Thero.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
