---
title: "How to use EcoDiet with stomachal and isotopic data"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use EcoDiet with stomachal and isotopic data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of EcoDiet is to combine two sources of data: isotopic and stomachal data with priors based on the litterature to model the trophic links and diet matrix.

There are two ways to use this package:

* With stomachal and isotopic data, and a study from the literature allowing to set specific priors

* With stomachal and isotopic data only (so the priors will be uninformative by default)

In this vignette, we will explain the later and simpler use.


## Load the package

The first thing to do is to load the EcoDiet package.

```{r}
library(EcoDiet)
```

If you have an error, please try to reinstall everything following [the instructions in the README](https://github.com/heloisethero/EcoDiet/blob/master/README.md)

## Check your data

Your data should be in a specific format to be treated by the package. 

* Here is the example stomachal data:

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_stomach_data <- read.csv(example_stomach_data_path)
knitr::kable(example_stomach_data)
```

As you can see, the stomachal data should have the predator names as the column headers, and the first column should contains the prey names. The number represents the number of predator stomachs in which this prey was found. Here for the "huge" animals, 19 full stomachs were analyzed. "Large" animals' dead bodies were found in 17 of these stomachs, and "medium" animals' dead bodies were found in 12 of these stomachs.

The last row contains the number of full stomachs analyzed for each predator.

Note that you should enter the stomach data for **all** trophic groups, even the groups at the base of your ecosystem for which you did not analyze the stomachs. In that case, the column will be filled with zeros (as with the "small" animals in the example).

* Here is the example isotopic data:

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
example_isotope_data <- read.csv(example_isotope_data_path)
knitr::kable(example_isotope_data)
```

Each line representes one isotope sample, the first column indicates to which group the individual belongs, and the other columns contain the isotopic measures (for isotopes 13C and 15N in our example).

## Preprocess the data

* You first need to have loaded your csv files as shown previously. If you have a specific CSV format, you can try to use the `sep` argument to load your data:
```{r, eval = FALSE}
example_stomach_data <- read.csv("my_stomach_data.csv", sep = ";")
example_isotope_data <- read.csv("my_isotope_data.csv", sep = ";")
```

* You need to define the trophic enrichment factors that corresponds to your isotopic data. If your isotopic data files contains d13C and d15N data as in the example, then you should enter the trophic enrichment factors for the d13C and d15N isotopes (in that order):
```{r, eval = FALSE}
trophic_enrichment_factor = c(0.8, 3.4)
```

* You also need to precise that you won't use priors from the literature in the model:
```{r, eval = FALSE}
literature_prior = FALSE
```

* The `preprocess_data` function then check and rearrange the data in a specific format for the EcoDiet model to be able to run:
```{r}
data <- preprocess_data(stomach_data = example_stomach_data, 
                        isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE)
```

If an error appears, it means your data is not in the correct format. Please read the error message and try to make your data follow the example csv files.

## Check the trophic links matrix

The last message tells you to check the trophic links that will be investigated by the model. You cannot assume that all the trophic links are possible (a matrix filled with only ones) or your model will never converge. You therefore need to keep only the reasonnable trophic links (e.g., a whale cannot eat a shrimp). 

The matrix displayed by the `preprocess_data` function is based on the stomachal data but you can add another trophic link if you think it is important. For example, if I want to say that the "huge" animal can also eat "small" animals (even if none was found in the huge's stomachs), I can edit the trophic links matrix. This is the by-default trophic links matrix:

```{r}
trophic_links <- 1 * (data$o > 0)
print(trophic_links)
```

And here I add the trophic link that I find important:
```{r}
trophic_links["small", "huge"] <- 1
print(trophic_links)
```

Now if I enter the new matrix as an argument of the `preprocess_data` function, I can see that the new trophic links matrix is the one being used:
```{r}
data <- preprocess_data(stomach_data = example_stomach_data, 
                        isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE,
                        trophic_links = trophic_links)
```

Any additional link will make it harder for the model to converge, so you should not add them ligthly.

## Write the model

Then we need to write the model in the BUGS syntax with the `write_model` function. Note that we need to indicate that we will use uninformative priors here:

```{r}
model_string <- write_model(literature_prior = FALSE)
```

## Run the model

The model will likely take a long time to run, so first we will do a little test by trying:
```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

The test was done with only a thousand iterations, which was not enough for the model to converge (as you can see from the warning message). So you should re-run your model with a higher number of iterations:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e+06)
```

If you again see a warning message being printed, should look at the `model_warnings` vignette for solutions.

## Save the model's mean results

The model's results are automatically saved in a file named `mcmc_ouput` so you can access them using:
```{r, eval = FALSE}
load("mcmc_ouput.Rdata")
```

In Bayesian models, the parameters are modelled by probability distributions. So here the model's outputs are the approximated probability distributions for the trophic links between species (LAMBDA parameters) and the diet estimates of a prey for a predator (PI parameters). To summarize these distributions, we can use point estimates like the mean or the median.

We can access the mean (and other statistics) of the variables with the `summary` function:

```{r}
mcmc_summary <- summary(mcmc_output)$statistics
print(mcmc_summary)
```

And the results can be saved as a CSV:
```{r, eval = FALSE}
write.table(mcmc_summary, file = "mcmc_summary.csv", sep = ",")
```

## Save the model's distribution results

We can also see the quantiles of the distributions. The by-default quantiles are the 2.5%, 25%, 50%, 75% and 97.5% quantiles.

```{r}
mcmc_quantiles <- summary(mcmc_output)$quantiles
print(mcmc_quantiles)
```
Because the median is also the 50% quantile, we can thus access the median of the distributions this way.

If needed, we can also change the by-default quantiles, for example to obtain the 5% and the 95% quantiles:

```{r}
mcmc_quantiles <- summary(mcmc_output, quantiles = c(0.05, 0.95))$quantiles
print(mcmc_quantiles)
```

The results can again be saved as a CSV:
```{r, eval = FALSE}
write.table(mcmc_quantiles, file = "mcmc_quantiles.csv", sep = ",")
```

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```

