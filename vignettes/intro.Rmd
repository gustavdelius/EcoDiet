---
title: "How to use EcoDiet with stomachal and isotopic data"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use EcoDiet with stomachal and isotopic data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of EcoDiet is to combine isotopic and stomach content data with priors based on the litterature to make inferences on the trophic links and diet matrix.

There are two ways to use this package:

* Default option - Only stomach content and isotopic data will be used and non informative priors will be used by default ;

* Use informative priors derived from a litterature survey. Informative priors will be combined with stomach contents and isotopic data. 

In this vignette, we will explain how to run the default option (non informative prior).


## Load the package

The first thing to do is to load the EcoDiet package.

```{r}
library(EcoDiet)
```

If you have an error, please try to reinstall everything following [the instructions in the README](https://github.com/heloisethero/EcoDiet/blob/master/README.md)

## Check your data format

Your data should be in a specific format to be treated by the package. 


* Here is the example isotopic data:

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
example_isotope_data <- read.csv(example_isotope_data_path)
knitr::kable(example_isotope_data)
```

Each line representes one isotope sample, the first column indicates to which group the individual belongs, and the other columns contain the isotopic measures (for isotopes 13C and 15N in our example).

* Here is the example stomachal data:

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_stomach_data <- read.csv(example_stomach_data_path)
knitr::kable(example_stomach_data)
```

As you can see, the stomach content data should have the predator names as the column headers, and the first column should contain the prey names. The number represents the number of predator stomachs in which this prey was found. In this example, for the "huge" animals, 19 full stomachs were analyzed. "Large" animals' dead bodies were found in 17 of these stomachs, and "medium" animals' dead bodies were found in 12 of these stomachs.

The last row contains the number of full stomachs analyzed for each predator.

Note that you should enter the stomach content data for **all** trophic groups, even the groups at the base of your trophic network for which you did not analyze the stomachs. In that case, the column will be filled with zeros (as with the "small" animals in the example).

## Plot the data

You can visualize your data with the `plot_data` function:
```{r, fig1, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_data(isotope_data = example_isotope_data)
```

## Preprocess the data

* You first need to have loaded your csv files as shown previously. If you have a specific CSV format, you can try to use the `sep` argument to load your data:
```{r, eval = FALSE}
example_stomach_data <- read.csv("my_stomach_data.csv", sep = ";")
example_isotope_data <- read.csv("my_isotope_data.csv", sep = ";")
```

* You need to define the trophic enrichment factors that corresponds to your isotopic data. If your isotopic data files contains d13C and d15N data as in the example, then you should enter the trophic enrichment factors for the d13C and d15N isotopes (in that order):
```{r, eval = FALSE}
trophic_enrichment_factor = c(0.8, 3.4)
```

* You also need to precise that you won't use priors from the literature in the model:
```{r, eval = FALSE}
literature_prior = FALSE
```

* The `preprocess_data` function then check and rearrange the data in a specific format for the EcoDiet model to be able to run:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE,
                        stomach_data = example_stomach_data)
```

If an error appears, it means your data is not in the correct format. Please read the error message and try to rearrange the data in the suitable format as in the example.

## Check the trophic links matrix

The last message tells you to check the trophic links that will be investigated by the model. It is generally not possible to assume that all the trophic links are possible ( = a matrix filled with only ones), as it generally corresponds to an over-paramaterized model. The number of possible trophic link to be considered a priori must therefore be kept reasonnable (e.g., a whale cannot eat a shrimp). 

First, a default topological matrix derived from the stomach content datais proposed by the `preprocess_data`. The by-default topological matrix can be displayed by the following instruction : 

```{r}
trophic_links <- 1 * (data$o > 0)
print(trophic_links)
```

Additional trophic links (= trophic links that do not appear in the stomach content data but that exist a priori in the trophic network) can be added by the user. For example, to specify that the "huge" animal can also eat "small" animals (even if none was found in the huge's stomachs), the topological matrix can be edited and modified as follows:  

```{r}
trophic_links["small", "huge"] <- 1
print(trophic_links)
```

Now if I enter the new matrix as an argument of the `preprocess_data` function, I can see that the new trophic links matrix is the one being used:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data)
```

Note that any additional link will make the trophic network more complex, then more difficult to estimate. 

## Write the model

Then we need to write the model in the BUGS syntax with the `write_model` function. The option non informative priors / informative priors must be specified again at this level. 

```{r}
model_string <- write_model(literature_prior = FALSE)
```

## Run the model

The model will likely take a long time to run, so first we will do a little test by trying:
```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

The test was done with only a thousand iterations (1000 = the number of MCMC iterations by default), which was not enough for the model to converge (as you can see from the warning message). So you should re-run your model with a higher number of iterations:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e+06)
```

If you again see a warning message being printed, should look at the `model_warnings` vignette for solutions.

## Extract model's results

The model's results are automatically saved in a file named `mcmc_ouput` so you can access them using:
```{r, eval = FALSE}
load("mcmc_ouput.Rdata")
```

Raw format of model output are MCMC draws of all model parameters, used to approximate Bayesian posterior distributions. By default, MCMC draws are stored for parameters coding for the trophic links between species (LAMBDA parameters) and the diet estimates of a prey for a predator (PI parameters). To summarize these distributions, we can use point estimates like the mean or the median.

We can access the mean (and other statistics) of the variables with the `summary` function:

```{r}
mcmc_summary <- summary(mcmc_output)$statistics
print(mcmc_summary)
```
We can also extract the quantiles of the distributions. The by-default quantiles are the 2.5%, 25%, 50%, 75% and 97.5% quantiles.

```{r}
mcmc_quantiles <- summary(mcmc_output)$quantiles
print(mcmc_quantiles)
```

If needed, we can also change the by-default quantiles, for example to obtain the 5% and the 95% quantiles:

```{r}
mcmc_quantiles <- summary(mcmc_output, quantiles = c(0.05, 0.95))$quantiles
print(mcmc_quantiles)
```

## Save the model's distribution results

MCMC summary and quantiles can be saved as a CSV:
```{r, eval = FALSE}
write.table(mcmc_summary,   file = "mcmc_summary.csv",   sep = ",")
write.table(mcmc_quantiles, file = "mcmc_quantiles.csv", sep = ",")
```

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```

