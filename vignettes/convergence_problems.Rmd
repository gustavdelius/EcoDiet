---
title: "How to make the model converge"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to make the model converge}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette concerns the case in which your model did not manage to converge, i.e., the Gelman-Rubin diagnostic stayed above 1.05 for at least one variable. There are a few solutions that can be tried.

Of course before running the model, we neet to have preprocessed the data and written the model:

```{r}
library(EcoDiet)
data <- preprocess_data(ecodiet_example)
model_string <- write_model()
```

## Increase the number of iterations

The first thing that should be tried is to increase the number of iterations to run the model. The approximated probability distributions are bound to converge to their true distributions if enough iterations are given. 

So you should try to increase the `n_iter` argument, althouh this will likely takes several hours to run:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, n_iter = 1e+08)
```

## Specify initial values for the model

The next other thing that can be tried is to initiate the variables, i.e., to define starting points from which to run the MCMC chains.

Here we are using the data to define some fixed initialization values that we know are close to the values we want the model to converge to. This way the model should be faster to converge because it is given a good start:

```{r, results = 'hide'}
inits <- initialize_model(data, ecodiet_example$topo_run)
mcmc_output <- run_model(textConnection(model_string), data, inits = inits)
```

## Rescale your stomachal data

If the occurrences in your stomachal data are too small, you may need to rescale them, i.e., to increase them using the number of full stomachs as a reference. For that you can use the `rescale_stomach_data` function.

Here are our example stomachal data before rescaling them:

```{r}
data$o
```

And here are the stomachal data after they have been rescaled:

```{r}
data$o <- rescale_stomach_data(data$o, data$n_sca)
data$o
```