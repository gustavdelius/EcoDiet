---
title: "How to use EcoDiet with stomachal data, isotopic data and priors from the literature"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use EcoDiet with stomachal data, isotopic data and priors from the literature}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of EcoDiet is to combine isotopic and stomach content data with priors based on the litterature to make inferences on the trophic links and diet matrix.

There are two ways to use this package:

* Default option - Only stomach content and isotopic data will be used and non informative priors will be used by default ;

* Use informative priors derived from a litterature survey. Informative priors will be combined with stomach contents and isotopic data. 

In this vignette, the later option (with informative prior) will be explained.


## Load the package

The first thing to do is to load the EcoDiet package.

```{r}
library(EcoDiet)
```

EcoDiet requires the installation of JAGS (see [the README](https://github.com/heloisethero/EcoDiet/blob/master/README.md) if you have an error).

## Load and check your data

You can load your data by importing it from `.csv` files. Your data should be in a specific format to be treated by the package. 

* Isotopic data:

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
example_isotope_data <- read.csv(example_isotope_data_path)
knitr::kable(example_isotope_data)
```

Each line represents one isotope sample, the first column indicates to which group the individual belongs, and the other columns contain the isotopic measures (for isotopes 13C and 15N in our example).

* Stomachal data:

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_stomach_data <- read.csv(example_stomach_data_path)
knitr::kable(example_stomach_data)
```

As you can see, the stomach content data should have the predator names as the column headers, and the first column should contain the prey names. The number represents the number of predator stomachs in which this prey was found. In this example, for the "huge" animals, 19 full stomachs were analyzed. "Large" animals' dead bodies were found in 17 of these stomachs, and "medium" animals' dead bodies were found in 12 of these stomachs.

The last row contains the number of full stomachs analyzed for each predator.

Note that you should enter the stomach content data for **all** trophic groups, even the groups at the base of your trophic network for which you did not analyze the stomachs. In that case, the column will be filled with zeros (as with the "small" animals in the example).

* Diet matrix from the literature:

```{r}
example_literature_diets_path <- system.file("extdata", "example_literature_diets.csv",
                                    package = "EcoDiet")
example_literature_diets <- read.csv(example_literature_diets_path)
knitr::kable(example_literature_diets)
```

The numbers are a summary of the literature study. For example if you have found in articles that "huge" animals were found to eat both "large" and "medium" animals, and exceptionnally "small" animals, this is summarized by the 49%, 49% and 2% numbers in the first column. As for the stomachal data, **all** trophic groups should be entered in the matrix (even the "small" animals that are at the base of the ecosystem and are known to eat nobody).

These priors will be used for three things:

1. The proportions are used as priors for the diet proportions, i.e., they are entered as the parameters "alpha" of the Dirichlet prior distributions. By default (no a priori information), the Dirichlet prior is uninformative with parameter alpha = 1/k where k is the number of trophic links.

2. Specifying a priori information on the diet will automatically impact the topological matrix. It means that each number > 0 in the diet matrix will be used to create a possible trophic link that will be investigated by the model (more on this later).

3. All numbers will also be used to set the parameters for the prior Beta distributions of the probabilities of a trophic link. For each number > 0, the probabilities will be shifted toward 1, while for each number = 0, the probabilities will be shifted toward 0.

## Plot the data

You can visualize your data with the `plot_data` function:

```{r, fig1, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_data(isotope_data = example_isotope_data,
          stomach_data = example_stomach_data,
          literature_diets = example_literature_diets)
```

## Preprocess the data

* You first need to have loaded your `.csv` files as shown previously. 

If you have your files in a `data` folder and in a specific `.csv` format (semicolon separated, and not coma separated), you should add the `data` folder in the path and use the `sep` argument to load your data:
```{r, eval = FALSE}
example_stomach_data     <- read.csv("./data/my_stomach_data.csv",     sep = ";")
example_isotope_data     <- read.csv("./data/my_isotope_data.csv",     sep = ";")
example_literature_diets <- read.csv("./data/my_literature_diets.csv", sep = ";")
```

* You need to define the trophic enrichment factors that corresponds to your isotopic data. If your isotopic data files contains d13C and d15N data as in the example, then you should enter the trophic enrichment factors for the d13C and d15N isotopes (in that order):
```{r, eval = FALSE}
trophic_enrichment_factor = c(0.8, 3.4)
```

* You also need to precise that you will use priors from the literature in the model:
```{r, eval = FALSE}
literature_prior = TRUE
```

* The `preprocess_data` function then checks and rearranges the data in a specific format so that the EcoDiet model can be run:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = TRUE,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets)
```

If an error appears, it means your data is not in the correct format. Please read the error message and try to rearrange the data in the suitable format as in the example.

## Check the trophic links matrix

The last message tells you to check the trophic links that will be investigated by the model. It is generally not wise to assume that all the trophic links are possible ( = a matrix filled with only ones), as the model will likely be over-paramaterized and have problems to converge. You therefore need to keep only the reasonnable trophic links (e.g., a shrimp cannot eat a whale).

The matrix displayed by the `preprocess_data` function is based on the stomach content data and the literature diets. If you want to add another trophic link, you can modify the literature diets to add a small number for the prey-predator couple for which you want to add a trophic link.

For example if you know that the "huge" animals can exceptionnally eat "small" animals, even if it is not mentionned in the literature, you can modify the literature diets matrix this way:
```{r}
example_literature_diets[3, 2] <- 0.02
example_literature_diets[1, 2] <- 0.49
example_literature_diets[4, 2] <- 0.49
knitr::kable(example_literature_diets)
```

So now you can see that the trophic links matrix will be modified to take into account "huge" animals eating "small" animals:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = TRUE,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets)
```

## Other possible parameters impacting the prior distributions

The literature diets matrix is a crucial input to use the model with priors, as it used to set a prior on both the trophic link probabilities (eta variables) and the diet proportions (PI variables). 

But other parameters allow you to weight the influence of the prior relative to the data. To do so, three additional variables can be modified by the user:

* the `literature_pedigrees` parameters. This allows us to weight the influence of the prior relative to the data. Ideally information on the diets is extracted from studies recently conducted in the same area. But when local and recent data information is missing, it can also come from foreign areas or older periods with eventually different ecosystem structure and functioning, hence less pertinent regarding the case-study. You can down-weight the importance of these priors by setting a low pedigree score for this predator. You need to enter a pedigree score (a number between 0 to 1) for each predator. By default they are all equal to 1. Here is the example literature pedigrees:

```{r}
example_literature_pedigrees_path <- system.file("extdata", "example_literature_pedigrees.csv",
                                    package = "EcoDiet")
example_literature_pedigrees <- read.csv(example_literature_pedigrees_path)
knitr::kable(example_literature_pedigrees)
```

Here the diet proportions from the literature are estimated very reliable for the "huge" animals so the pedigree score associated is high (0.9), while the diet proportions for the "medium" animals come from a very old article, from a very different ecosystem so the pedigree score associated is low (0.2). Because the "small" animals are at the base of the ecosystem and its diet proportions won't be estimated, its pedigree score will not be used so we have put the by-default value (1).

* the `nb_literature` parameter. The higher this number, the more your prior on the trophic link probabilities (eta) will have an impact on the results. Setting this parameter to 10 is like saying that the prior from the literature will weight as much as additional data from 10 stomachs. Thus for any particular application, `nb_literature` should be set relative to the sample size in the available stomachal data. By default it is equal to 10, but you can set it to any number:

```{r}
nb_literature = 12
```

* the `literature_slope` parameter. By default it is equal to 0.5.

You can set different values for these parameters with the `preprocess_data` function:

```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = TRUE,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        literature_pedigrees = example_literature_pedigrees,
                        nb_literature = 12,
                        literature_slope = 0.6)
```


## Write the model

The `write_model` function writes the model in the BUGS syntax. The option non informative priors / informative priors must be specified again at this level. 

```{r}
model_string <- write_model(literature_prior = TRUE)
```

## Run the model

Run the model is a long process. So first do this to run a quick test:
```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

The test was done with only a thousand iterations (1000 = the number of MCMC iterations by default), which was not enough for the model to converge (as you can see from the warning message). So you should re-run your model with a higher number of iterations:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e+06)
```

If you see again a warning message being printed, you should look at the `model_warnings` vignette for solutions.

## Save the model's mean results

The model's results are automatically saved in a file named `mcmc_ouput` so you can access them using:
```{r, eval = FALSE}
load("mcmc_ouput.Rdata")
```

Raw format of model output are MCMC draws of all model parameters, used to approximate Bayesian posterior distributions. By default, MCMC draws are stored for parameters coding for the trophic links between species (eta parameters) and the diet estimates of a prey for a predator (PI parameters). To summarize these distributions, point estimates can be used like the mean or the quantiles.

The mean (and other statistics) of the variables can be accessed with the `summary` function:

```{r}
mcmc_summary <- summary(mcmc_output)$statistics
print(mcmc_summary)
```
The quantiles of the distributions can also be extracted. The by-default quantiles are the 2.5%, 25%, 50%, 75% and 97.5% quantiles.

```{r}
mcmc_quantiles <- summary(mcmc_output)$quantiles
print(mcmc_quantiles)
```

The by-default quantiles cna be changed if needed. This is the instruction to obtain the 5% and the 95% quantiles:

```{r}
mcmc_quantiles <- summary(mcmc_output, quantiles = c(0.05, 0.95))$quantiles
print(mcmc_quantiles)
```

## Save the model's distribution results

MCMC summary and quantiles can be saved as a CSV:
```{r, eval = FALSE}
write.table(mcmc_summary,   file = "mcmc_summary.csv",   sep = ",")
write.table(mcmc_quantiles, file = "mcmc_quantiles.csv", sep = ",")
```

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```

