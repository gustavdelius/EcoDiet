---
title: "How to use EcoDiet with stomachal data, isotopic data and priors from the literature"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use EcoDiet with stomachal data, isotopic data and priors from the literature}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of EcoDiet is to combine two sources of data: isotopic and stomachal data with priors based on the litterature to model the trophic links and diet matrix.

There are two ways to use this package:

* With stomachal and isotopic data, and a study from the literature allowing to set specific priors

* With stomachal and isotopic data only (so the priors will be uninformative by default)

In this vignette, we will explain the former and more complicated use.


## Load the package

The first thing to do is to load the EcoDiet package.

```{r}
library(EcoDiet)
```

If you have an error, please try to reinstall everything following [the instructions in the README](https://github.com/heloisethero/EcoDiet/blob/master/README.md)

## Load and check your data

You can load your data by importing it as `.csv` files. Your data should be in a specific format to be treated by the package. 

* Here is the example stomachal data:

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_stomach_data <- read.csv(example_stomach_data_path)
knitr::kable(example_stomach_data)
```

As you can see, the stomachal data should display the predator names in the column headers, and the first column should contain the prey names. The number represents the number of predator stomachs in which this prey was found. Here for the "huge" animals, 19 full stomachs were analyzed. "Large" animals' remaining pieces were found in 17 of these stomachs, and "medium" animals' remaining pieces were found in 12 of these stomachs.

The last row contains the number of non-empty stomachs analyzed for each predator.

Note that you should enter the stomach data for **all** trophic groups, even the groups at the base of the food-web for which no stomach analysis was conducted. In that case, the column will be filled with zeros (as with the "small" animals in the example).

* Here is the example isotopic data:

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
example_isotope_data <- read.csv(example_isotope_data_path)
knitr::kable(example_isotope_data)
```

Each line represents one single individual sampled, the first column indicates to which trophic group it belongs, and the other columns contain the isotopic measurements (isotopes 13C and 15N in our example).

* Here is the example diet matrix from the literature:

```{r}
example_literature_diets_path <- system.file("extdata", "example_literature_diets.csv",
                                    package = "EcoDiet")
example_literature_diets <- read.csv(example_literature_diets_path)
knitr::kable(example_literature_diets)
```

The numbers are a summary of the literature study. For example if you have found in articles that "huge" animals were found to eat both "large" and "medium" animals, and exceptionnally "small" animals, this is summarized by the 49%, 49% and 2% numbers in the first column. As for the stomachal data, **all** trophic groups should be entered in the matrix (even the "small" animals that are at the base of the ecosystem and are known to eat nobody).

These priors will be used for two things:

1. Each number > 0 will be used to create a possible trophic link that will be investigated by the model (more on this later).

2. All numbers are used as the hyperparameters alpha of the Dirichlet distributions for the diet proportions priors.

## Preprocess the data

* You first need to have loaded your CSV files as shown previously. 

If you have your files in a `data` folder and in a specific `.csv` format (semicolon separated, and not coma separated), you can try this:
```{r, eval = FALSE}
example_stomach_data    <- read.csv("./data/my_stomach_data.csv",    sep = ";")
example_isotope_data    <- read.csv("./data/my_isotope_data.csv",    sep = ";")
example_literature_diets <- read.csv("./data/my_literature_diets.csv", sep = ";")
```

* You need to define the trophic enrichment factors that corresponds to your isotopic data. If your isotopic data files contains d13C and d15N data as in the example, then you should enter the trophic enrichment factors for the d13C and d15N isotopes (in that order):
```{r, eval = FALSE}
trophic_enrichment_factor = c(0.8, 3.4)
```

* You also need to precise that you will use priors from the literature in the model:
```{r, eval = FALSE}
literature_prior = TRUE
```

* The `preprocess_data` function then checks and rearranges the data in a specific format so that the EcoDiet model can be run:
```{r}
data <- preprocess_data(stomach_data = example_stomach_data, 
                        isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = TRUE,
                        literature_diets = example_literature_diets)
```

If any error appears, it means your data is not in the correct format. Please read the error message and try to make your data follow the example csv files.

## Check the trophic links matrix

The last message tells you to check the trophic links that will be investigated by the model. You cannot assume that all the trophic links are possible (a matrix filled with only ones) or your model will never converge. You therefore need to keep only the reasonnable trophic links (e.g., a whale cannot eat a shrimp). 

The matrix displayed by the `preprocess_data` function is based on the stomachal data and the literature diets. If you want to add another trophic link, you can just modify the literature diets to add a small number for the prey-predator couple for which you want to add a trophic link.

## Ohter possible prior parameters

## Write the model

Then we need to write the model in the BUGS syntax with the `write_model` function. Note that we need to indicate that we will use uninformative priors here:

```{r}
model_string <- write_model(literature_prior = TRUE)
```

## Run the model

The model will likely take a long time to run, so first we will do a little test by trying:
```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

The test was done with only a thousand iterations, which was not enough for the model to converge (as you can see from the warning message). So you should re-run your model with a higher number of iterations:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e+06)
```

If you again see a warning message being printed, should look at the `model_warnings` vignette for solutions.

## Save the model's mean results

The model's results are automatically saved in a file named `mcmc_ouput` so you can access them using:
```{r, eval = FALSE}
load("mcmc_ouput.Rdata")
```

In Bayesian models, the parameters are modelled by probability distributions. So here the model's outputs are the approximated probability distributions for the trophic links between species (LAMBDA parameters) and the diet estimates of a prey for a predator (PI parameters). To summarize these distributions, we can use point estimates like the mean or the median.

We can access the mean (and other statistics) of the variables with the `summary` function:

```{r}
mcmc_summary <- summary(mcmc_output)$statistics
print(mcmc_summary)
```

And the results can be saved as a CSV:
```{r, eval = FALSE}
write.table(mcmc_summary, file = "mcmc_summary.csv", sep = ",")
```

## Save the model's distribution results

We can also see the quantiles of the distributions. The by-default quantiles are the 2.5%, 25%, 50%, 75% and 97.5% quantiles.

```{r}
mcmc_quantiles <- summary(mcmc_output)$quantiles
print(mcmc_quantiles)
```
Because the median is also the 50% quantile, we can thus access the median of the distributions this way.

If needed, we can also change the by-default quantiles, for example to obtain the 5% and the 95% quantiles:

```{r}
mcmc_quantiles <- summary(mcmc_output, quantiles = c(0.05, 0.95))$quantiles
print(mcmc_quantiles)
```

The results can again be saved as a CSV:
```{r, eval = FALSE}
write.table(mcmc_quantiles, file = "mcmc_quantiles.csv", sep = ",")
```

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```

