---
title: "Introduction - How to use EcoDiet (quick start)"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1. Introduction - How to use EcoDiet (quick start)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of the package is to estimate trophic links probabilities (who eats whom in the food web) and diet proportions (in which proportions each prey is eaten) by combining biotracers and stomach content analyses in a Bayesian hierarchical model. The full model and its application on a real dataset are described in *Hernvann et al.* (under review).

There are different ways of using this package:

* *Default option* - you have only stomach content and biotracers data, so non informative priors will be used;

* *Literature option* - you have stomach content and biotracers data, and results from a literature search that will be used to formulate informative priors. 

The following example is an artificial dataset, created to be simple to visualize and understand. Note that the biotracers data used here are stable isotopes, but EcoDiet could be used to treat other analyses such as fatty acids or specific-compounds stable isotopes.

## Load the package

Follow the [README](https://github.com/heloisethero/EcoDiet/blob/master/README.md)'s instructions, and then load the EcoDiet package:

```{r}
library(EcoDiet)
```

## Load and check your data

Your data should be in a specific format, similar to those of following example. You can load your data by importing it from `.csv` files or directly as R data.frames. 

If you have the CSV files in a `data` folder and in a specific `.csv` format (semicolon separated, and not coma separated), you can try something like this:

```{r, eval = FALSE}
example_stomach_data <- read.csv("./data/my_stomach_data.csv", sep = ";")
example_isotope_data <- read.csv("./data/my_isotope_data.csv", sep = ";")
```

### Stomach content data

The stomach content table gathers the sum of occurrences of each prey type in the stomachs of each trophic group. The first column of the table contains the names of the prey type and the headers of the following columns contain the names of all the trophic groups. The last row of the table should be named "full", and indicates how many (non-empty) stomachs have been analyzed for each trophic group.

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_stomach_data <- read.csv(example_stomach_data_path)
knitr::kable(example_stomach_data)
```

In this example, for the "huge" animals, 19 stomachs were analyzed and contained remainings. Among these stomachs, 17 contained "large" animal remainings and 12 contained "medium" animal remainings.

If you have trophic groups for which no stomach content analyses were done, you should fill the column with zeros (it is the case here for "small" animals that are at the base of the trophic network).

### Biotracer data

Each line of the table represents one individual on which were conducted stable isotope analyses for various elements (carbon and nitrogen here). The first column of the table should be called "group" and indicates to which trophic group the individual belongs. The other columns contain the measures.

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
example_isotope_data <- read.csv(example_isotope_data_path)
knitr::kable(example_isotope_data)
```

You should have the same trophic groups in your stomach and isotope data. Thus, if you have a group with stomach content analyses but without biotracer data, you should still enter it as one line in the biotracer data with "NA" values (as it is the case for the "huge" group).

You also need to define the trophic enrichment factors corresponding to your isotopic data. In this example, because we have data for the d13C and d15N isotopes,  we use the corresponding trophic enrichment factors:

```{r, eval = FALSE}
trophic_enrichment_factor = c(0.8, 3.4)
```

## Plot the data

You can visualize your data with the `plot_data` function:

```{r, fig1, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_data(isotope_data = example_isotope_data,
          stomach_data = example_stomach_data)
```

## Preprocess your data without prior (*Default option*)

**Skip this part if you want to use EcoDiet with prior from the literature.**

### Preprocess the data

The `preprocess_data` function checks and rearranges the data in a specific format so that the EcoDiet model can be run:

```{r}
literature_prior <- FALSE

data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        stomach_data = example_stomach_data)
```

If any error appears, it means your data is not in the correct format. Please read the error message and rearrange your data in the correct format.

### Check the trophic links

The last message tells you to check the trophic links that will be investigated by the model. It is generally not wise to assume that all the trophic links are possible ( = a matrix filled with only ones), as the model will likely be over-paramaterized and have problems to converge. You therefore need to keep only the reasonnable trophic links (e.g., a shrimp cannot eat a whale). 

The matrix displayed by the `preprocess_data` function is based on the stomach content data, so by-default EcoDiet will investigate trophic links only based on what you have found in stomachs analyses (`data$o`):

```{r}
trophic_links <- 1 * (data$o > 0)
print(trophic_links)
```

If you want to add another trophic link, you can modify directly the topological matrix. This can be useful if your stomach sampling size is too low and you missed a prey you are definitely sure that the predator feeds on, or if the prey is difficulty identifiable is stomachs (e.g., really small and highly digestible prey). For example, to specify that the "huge" animal can also eat "small" animals despite none was found in the huge's stomachs, you can do:  

```{r}
trophic_links["small", "huge"] <- 1
print(trophic_links)
```

Now, the new topological matrix can be entered as an argument of the `preprocess_data` function, and you can see that the new trophic links matrix will be investigated by the model:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data)
```


## Preprocess your data with prior (*Literature option*)

**Skip this part if you want to use EcoDiet without prior from the literature.**

### Define the priors

You will use a literature diet table to set priors on the trophic link probabilities (the `eta` variables) and the diet proportions (the `PI` variables). This table is similar to the stomach contents table, as all trophic groups must be included in the columns and rows. The numbers are the the average diets proportions found in the literature. Here, the selected studies have identified that "huge" animals eat equally "large" and "medium" animals (thus the 0.5 and 0.5 numbers in the first column). The proportions for a given predator (i.e., within a given column) must sum to 1. The "small" animals are at the base of the ecosystem, so the column is filled with zeros.

The last row of the table corresponds to the literature pedigree score. This score (a number from 0 to 1) quantifies the literature reliability on each predator's diet. Here the dietary proportions from the literature are estimated very reliable for the "huge" animals, so the pedigree score associated is high (0.9). On the contrary, the diet proportions for the "medium" animals come from an old article focusing on a very different ecosystem so the pedigree score associated is low (0.2). Because the diet proportions won't be estimated for the "small" animals, we have put the by-default value for the pedigree (1).

```{r}
example_literature_diets_path <- system.file("extdata", "example_literature_diets.csv",
                                    package = "EcoDiet")
example_literature_diets <- read.csv(example_literature_diets_path)
knitr::kable(example_literature_diets)
```

This summary of the literature knowledge will be used to formulate:

1. The prior on the trophic link probabilities `eta`. If the literature diet proportion is zero, the prior Beta distribution of `eta` will be shifted to 0. If the proportion is positive, the distribution will be shifted toward 1.

2. The priors on the diet proportions `PI`. The literature diet proportions are entered as the hyperparameters of the prior Dirichlet distribution of `PI`.

The Pedigree scores are used to determine these priors' precision. Other parameters can be used to adjust the prior distributions:

* the `nb_literature` parameter (an integer higher than 2). The higher this nummber, the stronger will be the weight of the literature in the final inference for `eta`. Setting this parameter to 10 is like saying that the prior from the literature will weight as much as additional data from 10 stomachs. Thus for any particular application, `nb_literature` should be set to a value smaller than the sample size in the available stomachal data.

```{r}
nb_literature = 10
```

* the `literature_slope` parameter (a value between 0 and 1). The higher this number, the stronger will be the weight of the literature in the final inference for `PI`. You should set this value depending on the value of your data (number of biotracers, etc).

```{r}
literature_slope = 0.5
```

### Preprocess the data

The `preprocess_data` function then checks and rearranges the data in a specific format so that the EcoDiet model can be run:

```{r}
literature_prior <- TRUE

data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        nb_literature = 10,
                        literature_slope = 0.5)
```

If any error appears, it means your data is not in the correct format. Please read the error message and try to rearrange the data in the correct format.

### Check the trophic links

These are the links that will be investigated by the model. The matrix displayed by the `preprocess_data` function is based by default on the stomach content data (`data$o`) and on the literature diets matrix (`data$alpha_lit`):

```{r}
trophic_links <- 1 * ((data$o > 0) | (data$alpha_lit > 0))
print(trophic_links)
```

If you want to add another trophic link, you can modify directly the topological matrix. For instance, it can be useful if you are definitely sure that a prey is consumed by a given predator but your stomach sampling size is too small to allow any observation and the study extracted from the literature did not identify the prey because the prey is absent of the ecosystem where it was conducted. In our study case, to specify that the "huge" animal can also eat "small" animals (even if none was found in the huge's stomachs), you can do:

```{r}
trophic_links["small", "huge"] <- 1
print(trophic_links)
```

Now the new topological matrix can be entered as an argument of the `preprocess_data` function, and you can see that the new trophic links matrix will be investigated by the model:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        nb_literature = 10,
                        literature_slope = 0.5)
```

## Plot the priors

Whether the priors are informed by the literature or non-informative, you can plot the mean of the prior distributions for the trophic link probabilities (`eta`) and the diet proportions (`PI`):

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_prior(data, literature_prior)
```

You can also see the prior distributions for one trophic group (or predator):

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_prior(data, literature_prior, pred = "huge")
```

This way, you can change the prior parameters and see how it affects the prior distributions. Here, we will change the `nb_literature` parameter from 10 to 2:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        nb_literature = 2,
                        literature_slope = 0.5)

plot_prior(data, literature_prior, pred = "huge", variable = "eta")
```


## Write the model

The `write_model` function writes the model in the BUGS syntax. You need to specify the option non informative priors / informative priors:

```{r}
model_string <- write_model(literature_prior = literature_prior)
```

## Run the model

Now that the model is defined, you can run it. By default the numbers of MCMC adaption steps and iterations are very low (10 and 100 respectively) to test if your model is compiling properly:

```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

This low number of iterations will surely not be enough to achieve a satisfactory model convergence. You should progressively increase the number of adaptation steps and of iterations until you no longer see a "stopping adaptation" note, or a "convergence problem" message:

```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_adapt = 1e3, nb_iter = 1e6)
```

Depending on your data, the model can be very long to reach convergence (a few hours to a few days). This vignette is about convergence problems: `vignette("convergence_problems")`.

## Plot and save the model's mean results

The model's outputs are the approximated a posteriori distributions for the trophic links probabilities (`eta`) and the diet propotions (`PI`). You can visualize the mean of these distribitions with the `plot_results` function:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_results(mcmc_output, data)
```

The means are automatically saved when running this function. You can load and save them as `.csv` tables:

```{r, eval = FALSE}
load("PI_mean.Rdata")
write.table(PI_mean,  file = "PI_mean.csv",  sep = ",", col.names = NA)

load("eta_mean.Rdata")
write.table(eta_mean, file = "eta_mean.csv", sep = ",", col.names = NA)
```

## Plot the probability densities

You can also plot the whole probability densities for one predator:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_results(mcmc_output, data, pred = "huge")
```

You can also precise for which variable and preys you want to plot the probability densities:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_results(mcmc_output, data, variable = "PI", pred = "huge", prey = c("large", "small"))
```

You can see that the a posteriori `PI` distributions are mostly concentrated around 0. **But you should not interpret this as the "huge" predator eating most of the time 0 % of the "small" animals, with very few indivudals eating them sometimes.**

The `PI` distributions are very peaked around 0 because of how the `PI` variables are modelled in EcoDiet. EcoDiet is a model with probabilistic trophic links. The model first evaluates whether the trophic link exists or not between a predator and his prey. If the trophic link is seen as existing, the `PI` will be computed based on the biotracer data and the literature prior. But if the trophic link is evaluted as non-existent, the `PI` will be set at a quasi-null value. Because the sum of the diet proportions equals 1, if there are only 2 preys and one `PI` is fixed at 0, the other `PI` will automatically be fixed at 1. 

Thus only values far from 0 and 1 can inform us on the "real" values for the diet propotions `PI`. Here is how to plot these values:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
len <- dim(mcmc_output)[2]
mcmc_output[, 1:(len/2)] <- ifelse(mcmc_output[, 1:(len/2)] < 0.05 | mcmc_output[, 1:(len/2)] > 0.95, 
                                   NA, mcmc_output[, 1:(len/2)])

plot_results(mcmc_output, data, variable = "PI", pred = "huge", prey = c("large", "small"))
```

## Save the full results

The model's full results are automatically saved in a file named `mcmc_ouput` so you can access them using:

```{r}
load("mcmc_output.Rdata")
mcmc_output <- signif(mcmc_output, digits = 2)
knitr::kable(head(mcmc_output))
```

You can now compute any summary statistics that you need. If you want the median (thus the 50% quantile), and the 5% and the 95% quantiles of your distribution, you can use:

```{r}
quantiles <- apply(mcmc_output, 2, function(X) quantile(X, probs = c(0.05, 0.5, 0.95)))
quantiles <- signif(quantiles, digits = 2)
knitr::kable(quantiles)
```

The quantiles can finally be saved as `.csv` tables:
```{r, eval = FALSE}
write.table(quantiles, file = "quantiles.csv", sep = ",", col.names = NA)
```

## Save another variable than PI and eta

You have the possibility to access all the model parameters. For example you may be interested by the variable `delta` that represents the trophic enrichment factor. In the EcoDiet model, a different trophic enrichment factor is used for each trophic group and for each element, allowing some differences between species. We can save these parameters using the `variables_to_save` argument:

```{r}
mcmc_output <- run_model(textConnection(model_string), data,
                         variables_to_save = c("delta"))
```

And now you can access its mean value using:

```{r}
print(colMeans(mcmc_output))
```
