---
title: "Introduction - How to use EcoDiet (quick start)"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1. Introduction - How to use EcoDiet (quick start)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of the package is to estimate trophic links probabilities (who eats whom in the food web) and diet proportions (in which proportions each prey is eaten) by combining biotracers and stomach content analyses in a Bayesian hierarchical model.

There are different ways of using this package:

* *Default option* - you have only stomach content and biotracers data, and non informative priors will be used;

* *Literature option* - you have stomach content and biotracers data, and results from a literature search that will be used to formulate informative priors. 

The following example is an artificial dataset, created to be simple to visualize and understand. Note that the biotracers data used here are stable isotopes, but EcoDiet could be used to treat other analyses such as fatty acids or specific-compounds stable isotopes.

## Load the package

Follow the [README](https://github.com/heloisethero/EcoDiet/blob/master/README.md)'s instructions, and then load the EcoDiet package:

```{r}
library(EcoDiet)
```

## Load and check your data

Your data should be in a specific format, similar to those of following example. You can load your data by importing it from `.csv` files or directly as R data.frames. 

If you have the CSV files in a `data` folder and in a specific `.csv` format (semicolon separated, and not coma separated), you can try something like this:

```{r, eval = FALSE}
example_stomach_data <- read.csv("./data/my_stomach_data.csv", sep = ";")
example_isotope_data <- read.csv("./data/my_isotope_data.csv", sep = ";")
```

### Stomach content data

The stomach content table gathers the sum of occurrences of each prey type in the stomachs of each trophic group. The first column of the table contains the names of the prey type and the headers of the following columns contain the names of all the trophic groups. The last row of the table should be named "full", and indicates how many (non-empty) stomachs have been analyzed for each trophic group.

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_stomach_data <- read.csv(example_stomach_data_path)
knitr::kable(example_stomach_data)
```

In this example, for the "huge" animals, 19 stomachs were analyzed and contained remainings. Among these stomachs, 17 contained "large" animal remainings and 12 contained "medium" animal remainings.

If you have trophic groups for which no stomach content analyses were done, you should fill the column with zeros (it is the case here for "small" animals that are at the base of the trophic network).

### Biotracer data

Each line of the table represents one individual on which were conducted stable isotope analyses for various elements (carbon and nitrogen here). The first column of the table should be called "group" and indicates to which trophic group the individual belongs. The other columns contain the measures.

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
example_isotope_data <- read.csv(example_isotope_data_path)
knitr::kable(example_isotope_data)
```

You also need to define the trophic enrichment factors corresponding to your isotopic data. In this example, because we have data for the d13C and d15N isotopes,  we use the corresponding trophic enrichment factors:

```{r, eval = FALSE}
trophic_enrichment_factor = c(0.8, 3.4)
```

## Plot the data

You can visualize your data with the `plot_data` function:

```{r, fig1, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_data(isotope_data = example_isotope_data,
          stomach_data = example_stomach_data)
```

## Preprocess your data without prior (*Default option*)

The `preprocess_data` function checks and rearranges the data in a specific format so that the EcoDiet model can be run:

```{r}
literature_prior <- FALSE

data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        stomach_data = example_stomach_data)
```

If any error appears, it means your data is not in the correct format. Please read the error message and rearrange your data in the correct format.

The last message tells you to check the trophic links that will be investigated by the model. It is generally not wise to assume that all the trophic links are possible ( = a matrix filled with only ones), as the model will likely be over-paramaterized and have problems to converge. You therefore need to keep only the reasonnable trophic links (e.g., a shrimp cannot eat a whale). 

The matrix displayed by the `preprocess_data` function is based on the stomach content data, so by-default EcoDiet will investigate trophic links only based on what you have found in stomachs analyses (`data$o`):

```{r}
trophic_links <- 1 * (data$o > 0)
print(trophic_links)
```

If you want to add another trophic link, you can modify directly the topological matrix. This can be useful if your stomach sampling size is too low and you missed a prey you are definitely sure that the predator feeds on, or if the prey is difficulty identifiable is stomachs (e.g., really small and highly digestible prey). For example, to specify that the "huge" animal can also eat "small" animals despite none was found in the huge's stomachs, you can do:  

```{r}
trophic_links["small", "huge"] <- 1
print(trophic_links)
```

Now, the new topological matrix can be entered as an argument of the `preprocess_data` function, and you can see that the new trophic links matrix will be investigated by the model:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data)
```


## Preprocess your data with prior (*Literature option*)

**Skip this part if you want to use EcoDiet without prior from the literature.**

The calculation of the priors for the variables "eta" and "PI" mainly relies on a literature diet matrix, summarizing the knowledge on diets extracted from the literature, and Pedigree scores that quantifies the reliability of the literature-derived information on each predator's diet. As detailed below, the coefficients of the literature diet matrix are used to set the priors' mode, and the Pedigree scores are used to determine these priors' precision. Two additional parameters allow to modulate the relationship between the Pedigree value and the priors' precision for more adaptability to specific case studies.

* Diet matrix from the literature and the associated Pedigree scores:

```{r}
example_literature_diets_path <- system.file("extdata", "example_literature_diets.csv",
                                    package = "EcoDiet")
example_literature_diets <- read.csv(example_literature_diets_path)
knitr::kable(example_literature_diets)
```

This table is a diet matrix built from a literature study. As for the stomach contents table, all trophic groups must be included and there should be as many columns as rows as number of trophic groups. The matrix coefficients are the contributions (in decimal units) of the corresponding row-group to the diet of the corresponding column-group averaged over the selected studies. The coefficients within a given column must sum to 1, except if the column corresponds to a group at the base of the trophic network.  In this example, the selected studies identified that "huge" animals eat equally "large" and "medium" animals (thus the 0.5 and 0.5 numbers in the first column). The "small" animals are at the base of the ecosystem and their prey are not considered in the food-web representation.

This summary of the literature knowledge will be used to formulate:

1. The priors on the probabilities that links exist. Whether they are null or strictly positive, the coefficients of the diet matrix from the literature are used to respectively shift toward 0 or 1 the Beta distributions used as priors on the varaibles "eta".

2. The priors on dietary proportions. The coefficients of the diet matrix from the literature are entered as the hyperparameters "alpha" of the Dirichlet distributions for the priors on the variables "PI".

Finally, the last row of the matrix corresponds to the *literature pedigrees*. The Pedigree score (a number from 0 to 1) quantifies the relevance of the information found about a given consumer. Here the dietary proportions from the literature are estimated very reliable for the "huge" animals, so the pedigree score associated is high (0.9). On the contrary, the diet proportions for the "medium" animals come from an old article focusing on a very different ecosystem so the pedigree score associated is low (0.2). Because the "small" animals are at the base of the ecosystem and its diet proportions won't be estimated, its pedigree score will not be used so we have put the by-default value, which is 1. The Pedigree score is used to calculate the hyperparameters of the probability distributions used to formulate "eta" and "PI" priors.


* the `nb_literature` parameter. This parameter is used to formulate the prior on the "eta" parameters and is set by the user according to its study case. `nb_literature` is an integer equivalent to a number of stomachs sampled and, in a way, represents the number of stomachs that the user judges ideal to infer on a species' diet; in other words the number of stomachs that would be equivalent to a quantitative dietary study from the literature both locally and recently conducted following a good sampling scheme (i.e., of Pedigree 1).

For a given consumer, the ratio between the product `nb_literature * literature_pedigrees` and the number of stomachs determine the influence of the literature relative to data. Thus, the higher the `nb_literature` is, the stronger will be the weight of the literature in the final inferences. In practice, due to the inherent emptiness of stomachs when analyzing them, `nb_literature` should be set at a lower value in order to not put too much weight to the literature. Setting this parameter to 10 is like saying that the prior from the literature weights as much as additional data from 10 stomachs. There are no rules for attributing a value to `nb_literature`, but a good start can be the mean number of stomachs analyzed per species in the data sampled.

```{r}
nb_literature = 10
```

* the `literature_slope` parameter. This parameter is a number between 0 and 1 (excluding 0) used to calculate the hyperparameters of the Dirichlet priors for the PI parameter. To represent the greater uncertainty around dietary proportions from the literature when they come from a less relevant study, we fixed the hyperparameters so that their mean coefficient of variation increases with decreasing `literature_pedigrees`. This linear relationship is defined by an intercept giving a coefficient of variation of 1 for a null `literature_pedigrees`, and by a slope equal to `literature_slope`. Thus, increasing the`literature_slope` value tends to make the literature prior on dietary proportions stronger. This value is set by the user to adapt to specific cases, e.g. the number of biotracers used in the study etc. By default it is equal to 0.5.

```{r}
literature_slope = 0.5
```

The `preprocess_data` function then checks and rearranges the data in a specific format so that the EcoDiet model can be run:

```{r}
literature_prior <- TRUE

data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        nb_literature = 10,
                        literature_slope = 0.5)
```

If any error appears, it means your data is not in the correct format. Please read the error message and try to rearrange the data in the correct format.

* You should now check the trophic links matrix.

These are the links that will be investigated by the model. The matrix displayed by the `preprocess_data` function is based by default on the stomach content data (`data$o`) and on the literature diets matrix (`data$alpha_lit`):

```{r}
trophic_links <- 1 * ((data$o > 0) | (data$alpha_lit > 0))
print(trophic_links)
```

If you want to add another trophic link, you can modify directly the topological matrix. For instance, it can be useful if you are definitely sure that a prey is consumed by a given predator but your stomach sampling size is too small to allow any observation and the study extracted from the literature did not identify the prey because the prey is absent of the ecosystem where it was conducted. In our study case, to specify that the "huge" animal can also eat "small" animals (even if none was found in the huge's stomachs), you can do:

```{r}
trophic_links["small", "huge"] <- 1
print(trophic_links)
```

Now the new topological matrix can be entered as an argument of the `preprocess_data` function, and you can see that the new trophic links matrix will be investigated by the model:
```{r}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        nb_literature = 10,
                        literature_slope = 0.5)
```

## Plot the priors

Whether they are informed by the literature, or non-informative, you can now plot the mean priors for the `eta` and `PI` variables:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_prior(data, literature_prior)
```

You can also see the prior distributions for one predator if you wish:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_prior(data, literature_prior, pred = "huge")
```

This way, you can change the prior parameters and see how it affects the prior distributions (here, for example we have changed the `nb_literature` parameter from 10 to 2:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
data <- preprocess_data(isotope_data = example_isotope_data,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = literature_prior,
                        trophic_links = trophic_links,
                        stomach_data = example_stomach_data,
                        literature_diets = example_literature_diets,
                        nb_literature = 2,
                        literature_slope = 0.5)

plot_prior(data, literature_prior, pred = "huge", variable = "eta")
```


## Write the model

The `write_model` function writes the model in the BUGS syntax. The option non informative priors / informative priors must be specified at this level. 

```{r}
model_string <- write_model(literature_prior = literature_prior)
```

## Run the model

Now that the model is defined, you can use the function `run_model` to run the model. By default the number of MCMC iterations is very low (1,000), it allows you to test if your model is compiling properly. In most of the cases, this low number of iterations is not sufficient to achieve a satisfactory model convergence, as you can see from the warning message:

```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

We advise you to increase the number of iterations until you have met the convergence threshold:

```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e6)
```

If you see again a warning message being printed, you should follow the advices of the corresponding vignette: `vignette("model_warnings")`.

## Plot and save the model's mean results

In Bayesian models, the parameters are represented by their probability distributions. So here the model's outputs are the approximated probability distributions for the diet propotions (PI) and the trophic links probabilities (eta). To summarize these distributions, we can use point estimates like the mean and visualize it with the `plot_results` function:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_results(mcmc_output, data)
```

The means are automatically saved when running this function so you can access them and save them as `.csv` tables:

```{r, eval = FALSE}
load("PI_mean.Rdata")
write.table(PI_mean,  file = "PI_mean.csv",  sep = ",", col.names = NA)

load("eta_mean.Rdata")
write.table(eta_mean, file = "eta_mean.csv", sep = ",", col.names = NA)
```

## Plot the probability densities

You can also plot the probability densities for the `PI` variable and for one predator:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_results(mcmc_output, data, variable = "PI", pred = "huge")
```

If you find the plot to contain too much information, you can also precise for which preys you want to see the probability density:

```{r, fig.height = 4, fig.width = 6, fig.align = "center"}
plot_results(mcmc_output, data, variable = "PI", pred = "huge", prey = c("large", "small"))
```

## Save the full results

The model's full results are automatically saved in a file named `mcmc_ouput` so you can access them using:

```{r}
load("mcmc_output.Rdata")
mcmc_output <- signif(mcmc_output, digits = 2)
knitr::kable(head(mcmc_output))
```

You can now compute any summary statistics that you need, on top of the mean. For example if you want the median (thus the 50% quantile), and the 5% and the 95% quantiles of your distribution, you can use:

```{r}
quantiles <- apply(mcmc_output, 2, function(X) quantile(X, probs = c(0.05, 0.5, 0.95)))
quantiles <- signif(quantiles, digits = 2)
knitr::kable(quantiles)
```

The quantiles can finally be saved as `.csv` tables:
```{r, eval = FALSE}
write.table(quantiles, file = "quantiles.csv", sep = ",", col.names = NA)
```

## Save another variable than PI and eta

You have the possibility to access all the model parameters. For example you may be interested by the variable `delta` that represents the trophic enrichment factor. In the EcoDiet model, a different trophic enrichment factor is used for each trophic group and for each element, allowing some differences between species. We can save these parameters using the `variables_to_save` argument:

```{r}
mcmc_output <- run_model(textConnection(model_string), data,
                         variables_to_save = c("delta"))
```

And now you can access its mean value using:

```{r}
print(colMeans(mcmc_output))
```

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```
