---
title: "How to deal with convergence problems"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3. How to deal with convergence problems}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette concerns the case in which you had warnings for the `run_model` function.

* The 'adaptation incomplete' warning means that the samplers aren't optimised for your model after the adaptation phase. It means that JAGS doesn't think that it has adapted them to the optimal state. This tends to happen in complex models.

* The 'convergence problem' warning means that the Gelman-Rubin diagnostic stayed above 1.1 for at least one variable. The Gelman-Rubin statistic is used to measure convergence for each variable. The full statistic is saved as `convergence_diagnostic`, and you can acess it using:
```{r, eval = FALSE}
load("convergence_diagnostic.Rdata")
View(gelman)
```
It will allow you to understand which variables has not converged properly (the closer it is to 1, the better it has converged).

There are a few solutions that can be tried to eliminate the warnings.

Of course before running the model, you need to have preprocessed the data and written the model:

```{r}
library(EcoDiet)
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")

data <- preprocess_data(isotope_data = read.csv(example_isotope_data_path),
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE,
                        stomach_data = read.csv(example_stomach_data_path))

model_string <- write_model(literature_prior = FALSE)
```

## Increase the number of iterations

The first thing that should be tried is to increase the number of iterations to run the model. The approximated probability distributions are bound to converge to their true distributions if enough iterations are given. 

So you should try to increase the `nb_iter` argument, althouh this will likely takes several hours to run:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e+08)
```

## Increase the number of adaptation steps

The adaptation may be incomplete because not enough time was given to find optimal parameters. You can try to increase the `nb_adapt` argument:

```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, nb_iter = 1e+06, nb_adapt = 1e+04)
```

## Specify initial values for the model

The next step might be to define starting values from which to run the MCMC chains. By default JAGS will use the prior distributions to randomly fix the starting values of the chains, which can cause problems.

You can manually specify better initial values, i.e., values that you know are close to the values you want the model to converge to. This way the model should be faster to converge because it is given a good start.

## Conclusions

If you still have an 'adaptation incomplete' warning, you can just live with the sub-optimal sampler efficiency and run the model for longer

But if you still have a 'convergence problem' warning, you really need a solution. You cannot use the obtained results as they are clearly incorrect.

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```
