---
title: "Introduction to EcoDiet (quick start)"
author: "Heloise Thero"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to EcoDiet (quick start)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of EcoDiet is to combine two sources of data: isotopic and stomachal data with priors based on the litterature to model the trophic links and diet matrix.

There are two ways to use this package:
* With stomachal and isotopic data, and a study from the literature allowing to set specific priors
* With stomachal and isotopic data only (so the priors will be uninformative by default)
In this vignette, we will explain the later use. If you want to use the EcoDiet model with data from the literature, please read the `literature_prior` vignette.

## Load the package

The first thing to do is to load the EcoDiet package.

```{r}
library(EcoDiet)
```

If you have an error, please try to reinstall everything following [the instructions in the README](https://github.com/heloisethero/EcoDiet/blob/master/README.md)

## Put your data in the right format

Your data should be in a specific format to be treated by the package. Here is the example stomachal data:

```{r}
example_stomach_data_path <- system.file("extdata", "example_stomach_data.csv",
                                    package = "EcoDiet")
read.csv(example_stomach_data_path)
```

As you can see, the stomachal data should have the predator names as the column headers, and the first column should contains the prey names. The number represents the number of predator stomachs in which this prey was found. For example here "31" indicates that 31 medium animals were found in the big animals' stomachs. The last row contains the number of full stomachs analyzed for each predator.

Note that you should enter the stomach data for *all* trophic groups, even the groups at the base of your ecosystem for which you did not analyze the stomachs. In that case, the column will be filled with zeros (as with the "small" animals in the example).

Here is the example isotopic data:

```{r}
example_isotope_data_path <- system.file("extdata", "example_isotope_data.csv",
                                    package = "EcoDiet")
read.csv(example_isotope_data_path)
```

Each line is an isotope measurement from one individual, the first column indicates to which group the individual belongs, and the other column are the isotopic measures.

## Load the data

If your data is stored in two csv files (for example exported from Excel), you need to know the path of these two csv files in your computer. Here are the paths for the example data: 
```{r}
print(example_stomach_data_path)
```
```{r}
print(example_isotope_data_path)
```

And they will be used by the `preprocess_data` function:
```{r}
data <- preprocess_data(stomach_data_path = example_stomach_data_path, 
                        isotope_data_path = example_isotope_data_path,
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE)
```

Note that you need to specify the trophic enrichment factors that corresponds to your isotope data! If your isotopic data files contains d13C and d15N data as in the example, then you should enter the trophic enrichment factor for the d13C and d15N (in that order).

We also need to indicate that we will not use informative priors fixed from the literature with the argument `literature_prior`. If you want to add informative priors, please read the `literature_prior` vignette.

If you have put your two csv files in a folder named `my_EcoDiet_analysis`, then you need to run:

```{r, eval = FALSE}
data <- preprocess_data(stomach_data_path = "my_EcoDiet_analysis/my_stomach_data.csv", 
                        isotope_data_path = "my_EcoDiet_analysis/my_isotope_data.csv",
                        trophic_enrichment_factor = c(0.8, 3.4),
                        literature_prior = FALSE)
```

This function loads the data and rearrange it in a specific format for the EcoDiet model to be able to run. This is an important step that should not be skipped!

## Write the model

Then we need to write the model in the BUGS syntax with the `write_model` function. Note that we need to indicate that we will use uninformative priors here:

```{r}
model_string <- write_model(literature_prior = FALSE)
```

## Run the model

The model will likely take a long time to run, so first we will do a little test by trying:
```{r}
mcmc_output <- run_model(textConnection(model_string), data)
```

We have put a small number of iterations for this test (only a thousand). It was not enough for the model to converge as you can see from the printed message. So now you should now re-run your model with a higher number of iterations:
```{r, eval = FALSE}
mcmc_output <- run_model(textConnection(model_string), data, n_iter = 1e+06)
```

If you again see a convergence error with a million iterations, you should look at the `convergence_problems` vignette for solutions.

## Save the model's results

The model's results are automatically saved in a file named `mcmc_ouput` so you can access them using:
```{r, eval = FALSE}
load("mcmc_ouput.Rdata")
```

In Bayesian models, the parameters are modelled by probability distributions. So here the model's outputs are the approximated probability distributions for the trophic links between species (LAMBDA parameters) and the diet estimates of a prey for a predator (PI parameters). To summarize these distributions, we can use point estimates like the mean or the median.

We can access the mean (and other statistics) of the variables with the `summary` function:

```{r}
mcmc_summary <- summary(mcmc_output)$statistics
print(mcmc_summary)
```

We can also see the quantiles of the distributions with the same function. The by-default quantiles are the 2.5%, 25%, 50%, 75% and 97.5% quantiles. Because the median is also the 50% quantile, we can thus access the median of the distributions this way:

```{r}
mcmc_quantiles <- summary(mcmc_output)$quantiles
print(mcmc_quantiles)
```

If needed, we can also change the by-default quantiles, for example to obtain the 5% and the 95% quantiles:

```{r}
mcmc_quantiles <- summary(mcmc_output, quantiles = c(0.05, 0.95))$quantiles
print(mcmc_quantiles)
```

Finally these summary informations can be saved as csv files with the `write_csv` function:

```{r, eval = FALSE}
write.csv(mcmc_summary, file = "mcmc_summary.csv")
write.csv(mcmc_quantiles, file = "mcmc_quantiles.csv")
```

## Plot the results

## Environment on which this vignette has been run

```{r}
devtools::session_info()
```

